!function(){var a,b;BOOMR=BOOMR||{},BOOMR.plugins=BOOMR.plugins||{},BOOMR.plugins.BW||(b=[{name:"image-0.png",size:11773,timeout:1400},{name:"image-1.png",size:40836,timeout:1200},{name:"image-2.png",size:165544,timeout:1300},{name:"image-3.png",size:382946,timeout:1500},{name:"image-4.png",size:1236278,timeout:1200},{name:"image-5.png",size:4511798,timeout:1200},{name:"image-6.png",size:9092136,timeout:1200}],b.end=b.length,b.start=0,b.l={name:"image-l.gif",size:35,timeout:1e3},a={base_url:"",timeout:15e3,nruns:5,latency_runs:10,user_ip:"",block_beacon:!1,test_https:!1,cookie_exp:604800,cookie:"BA",results:[],latencies:[],latency:null,runs_left:0,aborted:!1,complete:!0,running:!1,initialized:!1,ncmp:function(a,b){return a-b},iqr:function(a){var b,c,d,e,f=a.length-1,g=[];if(b=(a[Math.floor(.25*f)]+a[Math.ceil(.25*f)])/2,c=(a[Math.floor(.75*f)]+a[Math.ceil(.75*f)])/2,d=1.5*(c-b),0===d)return a;for(f++,e=0;f>e&&a[e]<c+d;e++)a[e]>b-d&&g.push(a[e]);return g},calc_latency:function(){var a,b,c,d,e,f,g,h=0,i=0;for(this.latencies.shift(),g=this.iqr(this.latencies.sort(this.ncmp)),b=g.length,BOOMR.debug("latencies: "+this.latencies,"bw"),BOOMR.debug("lat_filtered: "+g,"bw"),a=0;b>a;a++)h+=g[a],i+=g[a]*g[a];return c=Math.round(h/b),e=Math.sqrt(i/b-h*h/(b*b)),f=(1.96*e/Math.sqrt(b)).toFixed(2),e=e.toFixed(2),d=Math.round((g[Math.floor(b/2)]+g[Math.ceil(b/2)])/2),{mean:c,median:d,stddev:e,stderr:f}},calc_bw:function(){var a,c,d,e,f,g,h,i,j,k,l,m,n,o,p=0,q=[],r=[],s=0,t=0,u=0,v=0,w=[];for(a=0;a<this.nruns;a++)if(this.results[a]&&this.results[a].r)for(d=this.results[a].r,m=0,c=d.length-1;c>=0&&3>m&&d[c];c--)null!==d[c].t&&(p++,m++,n=1e3*b[c].size/d[c].t,q.push(n),d[c].t>this.latency.mean?(o=1e3*b[c].size/(d[c].t-this.latency.mean),r.push(o)):w.push(c+"_"+d[c].t));for(BOOMR.debug("got "+p+" readings","bw"),BOOMR.debug("bandwidths: "+q,"bw"),BOOMR.debug("corrected: "+r,"bw"),q.length>3?(q=this.iqr(q.sort(this.ncmp)),r=this.iqr(r.sort(this.ncmp))):(q=q.sort(this.ncmp),r=r.sort(this.ncmp)),BOOMR.debug("after iqr: "+q,"bw"),BOOMR.debug("corrected: "+r,"bw"),p=Math.max(q.length,r.length),a=0;p>a;a++)a<q.length&&(s+=q[a],t+=Math.pow(q[a],2)),a<r.length&&(u+=r[a],v+=Math.pow(r[a],2));return p=q.length,e=Math.round(s/p),f=Math.sqrt(t/p-Math.pow(s/p,2)),g=Math.round(1.96*f/Math.sqrt(p)),f=Math.round(f),p=q.length-1,h=Math.round((q[Math.floor(p/2)]+q[Math.ceil(p/2)])/2),r.length<1?(BOOMR.debug("not enough valid corrected datapoints, falling back to uncorrected","bw"),w.push("l=="+r.length),i=e,j=f,k=g,l=h):(p=r.length,i=Math.round(u/p),j=Math.sqrt(v/p-Math.pow(u/p,2)),k=(1.96*j/Math.sqrt(p)).toFixed(2),j=j.toFixed(2),p=r.length-1,l=Math.round((r[Math.floor(p/2)]+r[Math.ceil(p/2)])/2)),BOOMR.debug("amean: "+e+", median: "+h,"bw"),BOOMR.debug("corrected amean: "+i+", median: "+l,"bw"),{mean:e,stddev:f,stderr:g,median:h,mean_corrected:i,stddev_corrected:j,stderr_corrected:k,median_corrected:l,debug_info:w}},load_img:function(a,c,d){function e(b){return function(){d&&d.call(j,a,h,c,b),null!==b&&(i.onload=i.onerror=null,i=null,clearTimeout(g),j=d=null)}}var f=this.base_url+b[a].name+"?t="+BOOMR.now()+Math.random(),g=0,h=0,i=new Image,j=this;i.onload=e(!0),i.onerror=e(!1),g=setTimeout(e(null),b[a].timeout+Math.min(400,this.latency?this.latency.mean:400)),h=BOOMR.now(),i.src=f},lat_loaded:function(a,b,c,d){if(c===this.latency_runs+1){if(null!==d){var e=BOOMR.now()-b;this.latencies.push(e)}0===this.latency_runs&&(this.latency=this.calc_latency()),BOOMR.setImmediate(this.iterate,null,null,this)}},img_loaded:function(a,c,d,e){if(d===this.runs_left+1&&!this.results[this.nruns-d].r[a]){if(null===e)return void(this.results[this.nruns-d].r[a+1]={t:null,state:null,run:d});var f={start:c,end:BOOMR.now(),t:null,state:e,run:d};e&&(f.t=f.end-f.start),this.results[this.nruns-d].r[a]=f,a>=b.end-1||void 0!==this.results[this.nruns-d].r[a+1]?(BOOMR.debug(BOOMR.utils.objectToString(this.results[this.nruns-d],void 0,2),"bw"),d===this.nruns&&(b.start=a),BOOMR.setImmediate(this.iterate,null,null,this)):this.load_img(a+1,d,this.img_loaded)}},finish:function(){this.latency||(this.latency=this.calc_latency());var a=this.calc_bw(),b={bw:a.median_corrected,bw_err:parseFloat(a.stderr_corrected,10),lat:this.latency.mean,lat_err:parseFloat(this.latency.stderr,10),bw_time:Math.round(BOOMR.now()/1e3)};BOOMR.addVar(b),a.debug_info.length>0&&BOOMR.addVar("bw_debug",a.debug_info.join(",")),!isNaN(b.bw)&&b.bw>0&&BOOMR.utils.setCookie(this.cookie,{ba:Math.round(b.bw),be:b.bw_err,l:b.lat,le:b.lat_err,ip:this.user_ip,t:b.bw_time},this.user_ip?this.cookie_exp:0),this.complete=!0,this.block_beacon===!0&&BOOMR.sendBeacon(),this.running=!1},iterate:function(){this.aborted||(this.runs_left?this.latency_runs?this.load_img("l",this.latency_runs--,this.lat_loaded):(this.results.push({r:[]}),this.load_img(b.start,this.runs_left--,this.img_loaded)):this.finish())},setVarsFromCookie:function(){var b,c,d,e,f,g,h,i,j;return b=BOOMR.utils.getSubCookies(BOOMR.utils.getCookie(a.cookie)),b&&b.ba&&(c=parseInt(b.ba,10),d=parseFloat(b.be,10),e=parseInt(b.l,10)||0,f=parseFloat(b.le,10)||0,g=b.ip.replace(/\.\d+$/,"0"),h=parseInt(b.t,10),i=this.user_ip.replace(/\.\d+$/,"0"),j=Math.round(BOOMR.now()/1e3),g===i&&h>=j-this.cookie_exp&&c>0)?(this.complete=!0,BOOMR.addVar({bw:c,lat:e,bw_err:d,lat_err:f,bw_time:h}),!0):!1}},BOOMR.plugins.BW={init:function(c){return a.initialized?this:(BOOMR.utils.pluginConfig(a,c,"BW",["base_url","timeout","nruns","cookie","cookie_exp","test_https","block_beacon"]),c&&c.user_ip&&(a.user_ip=c.user_ip),a.base_url?(b.start=0,a.runs_left=a.nruns,a.latency_runs=10,a.results=[],a.latencies=[],a.latency=null,a.complete=a.aborted=!1,BOOMR.removeVar("ba","ba_err","lat","lat_err"),a.setVarsFromCookie()||BOOMR.subscribe("page_ready",this.run,null,this),a.initialized=!0,this):this)},run:function(){var b;return a.running||a.complete?this:(b=BOOMR.window.document.createElement("a"),b.href=a.base_url,a.test_https||"https:"!==b.protocol?(a.base_url=b.href,a.running=!0,setTimeout(this.abort,a.timeout),a.iterate(),this):(BOOMR.info("HTTPS detected, skipping bandwidth test","bw"),a.complete=!0,a.block_beacon===!0&&BOOMR.sendBeacon(),this))},abort:function(){a.aborted=!0,a.running&&a.finish()},is_complete:function(){return a.block_beacon===!0?a.complete:!0}})}();
//# sourceMappingURL=bw.min.js.map